machine:
  environment:
  node:
    version: 4.8.3

dependencies:
  pre:
    - openssl aes-256-cbc -d -in bdf-cipher -out bdf-plain -k $KEY
    - chmod 400 bdf-plain
    - openssl aes-256-cbc -d -in bdf-prod-cipher -out bdf-prod-plain -k $KEYPROD
    - chmod 400 bdf-prod-plain
  override:
    - npm cache clean
    - npm install

test:
  override:
    - npm run sass-lint:
        environment:
          SITE_URL: "https://cpmidias-teste.brasildefato.com.br"

deployment:
  production:
    tag: /prod-.*/
    commands:
      - ./config_env.sh:
          environment:
            SITE_URL: "https://www.brasildefato.com.br"
            TOGGLE_lWzSf1WX_WEEKLY_RADIO_PROGRAM: "true"
            TOGGLE_LAST_NEWS: "true"
            TOGGLE_js_version: "true"
            TOGGLE_D6fenTno_ADSENSE: "false"
            TOGGLE_iftEQfOR_COLUMNIST_PAGE: "true"
            TOGGLE_css_version: "true"
            BANNER_RADIOAGENCIA: "true"
            TOGGLE_pio0zWc4_AUDIO_ON_LISTS: "true"
      - ssh -i bdf-prod-plain frida@brasildefato.com.br -C "/home/frida/components/frida-scripts/deploy-site.sh $CIRCLE_SHA1"
      - scp -i bdf-prod-plain _config.yml frida@brasildefato.com.br:/home/frida/components/site
  staging:
    branch: master
    tag:
      ignore:
        - /prod-.*/
    commands:
      - ./config_env.sh:
          environment:
            SITE_URL: "https://cpmidias-teste.brasildefato.com.br"
            TOGGLE_yhCw8OOd_LAST_NEWS_ANIMATION: "true"
            TOGGLE_js_version: "true"
            TOGGLE_D6fenTno_ADSENSE: "false"
            TOGGLE_css_version: "true"
            TOGGLE_TEST_ENVIROMENT: "true"
            BANNER_RADIOAGENCIA: "true"
            TOGGLE_iftEQfOR_COLUMNIST_PAGE: "true"
            TOGGLE_LAST_NEWS: "true"
            TOGGLE_lWzSf1WX_WEEKLY_RADIO_PROGRAM: "true"
            TOGGLE_pio0zWc4_AUDIO_ON_LISTS: "true"
      - scp -i bdf-plain _config.yml frida@cpmidias-teste.brasildefato.com.br:/home/frida/components/site
      - ssh -i bdf-plain frida@cpmidias-teste.brasildefato.com.br -C "/home/frida/components/frida-scripts/deploy-site.sh $CIRCLE_SHA1"
      - ssh -i bdf-plain frida@cpmidias-teste.brasildefato.com.br -C "PATH=$PATH:/usr/local/node/node-default/bin /home/frida/components/site/hexo-generate.sh /home/frida/components/site /www/site"
      - npm run validation-test
